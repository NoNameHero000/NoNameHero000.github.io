<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>æ“ºæ”¤ä½ç½®ç®¡ç†å¾Œå°</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MD5 -->
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script>

<style>
    body {
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #fafafa;
    }

    #loginBox, #adminBox {
        max-width: 900px;
        margin: auto;
        padding: 20px;
    }

    #adminBox { display: none; }

    input, button, textarea {
        width: 100%;
        padding: 10px;
        margin: 6px 0;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
    }

    button {
        background: #1e90ff;
        color: white;
        font-weight: bold;
        border: none;
        cursor: pointer;
    }

    button:hover {
        background: #187bdb;
    }

    #map {
        height: 380px;
        margin-top: 10px;
        border-radius: 10px;
        overflow: hidden;
    }

    /* èªªæ˜å½ˆçª— */
    #guidePopup {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: calc(100% - 40px);
        max-width: 480px;
        background: white;
        padding: 20px;
        border-radius: 14px;
        box-shadow: 0 0 20px rgba(0,0,0,0.2);
        z-index: 999;
        display: none;
    }

    #guidePopup h3 {
        margin-top: 0;
    }

    #guideClose {
        float: right;
        font-size: 22px;
        cursor: pointer;
        color: #888;
    }

    #helpBtn {
        position: fixed;
        top: 15px;
        right: 15px;
        background: #1e90ff;
        color: white;
        width: 42px;
        height: 42px;
        border-radius: 50%;
        font-size: 22px;
        display: none;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 15;
        box-shadow: 0 3px 12px rgba(0,0,0,0.25);
    }

    /* è¡¨æ ¼ */
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 14px;
    }

    th, td {
        border-bottom: 1px solid #ddd;
        padding: 8px;
    }

    th {
        background: #f0f0f0;
    }
</style>

</head>
<body>

<h2 style="text-align:center;margin-top:20px;">ğŸ“ æ“ºæ”¤ä½ç½®ç®¡ç†å¾Œå°</h2>

<!-- â“ èªªæ˜æŒ‰éˆ• -->
<div id="helpBtn">?</div>

<!-- ğŸ“˜ ä½¿ç”¨èªªæ˜å½ˆçª— -->
<div id="guidePopup">
    <span id="guideClose">Ã—</span>
    <h3>ä½¿ç”¨èªªæ˜</h3>

    <p>é€™æ˜¯è®“æ¿å¨˜å®‰å¿ƒå·¥ä½œçš„ç³»çµ±ï¼Œä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>

    <p><b>1ï¸âƒ£ æœå°‹ä»Šå¤©æ“ºæ”¤çš„ä½ç½®</b><br>
    è«‹åœ¨ä¸Šæ–¹æœå°‹æ¬„è¼¸å…¥åœ°é»ï¼Œä¾‹å¦‚ã€Œé«˜é›„è»Šç«™ã€ã€‚</p>

    <p><b>2ï¸âƒ£ é¸æ“‡åœ°é»å¾Œï¼Œåœ°åœ–æœƒè·³åˆ°è©²ä½ç½®</b><br>
    ä½ å¯ä»¥ç›´æ¥æŒ‰ã€Œä¿å­˜ã€ï¼Œæˆ–æ‰‹å‹•æ‹–å‹•åœ°åœ–ä¸Šçš„ç´…è‰²å®šä½é»ã€‚</p>

    <p><b>3ï¸âƒ£ åŠå¾‘é è¨­ 300 å…¬å°ºï¼Œå¯è‡ªè¡Œä¿®æ”¹</b></p>

    <p><b>4ï¸âƒ£ æ¨¡ç³Šæç¤ºï¼ˆhintï¼‰</b><br>
    å®¢æˆ¶é€²å…¥åŠå¾‘å¾Œæ‰èƒ½çœ‹åˆ°ï¼Œä¾‹å¦‚ï¼š<br>
    ã€Œä»Šå¤©æˆ‘å€‘åœ¨æŸæŸåœ‹å°é™„è¿‘ 300 å…¬å°ºå…§ã€</p>

    <p><b>5ï¸âƒ£ é»‘åå–®ï¼ˆå°é–å…§é¬¼ï¼‰</b><br>
    æ¯å€‹è£ç½®éƒ½æœ‰ UUIDï¼Œå¯åœ¨å¾Œå°ç›´æ¥å°é–ã€‚</p>

    <button onclick="document.getElementById('guidePopup').style.display='none'">
        æˆ‘çŸ¥é“äº†
    </button>
</div>

<!-- ğŸ” Login -->
<div id="loginBox">
    <h3>ç™»å…¥å¾Œå°</h3>
    <input id="acc">
    <input id="pwd" type="password">
    <button onclick="login()">ç™»å…¥</button>
</div>

<!-- ğŸ›  Admin åŠŸèƒ½ -->
<div id="adminBox">

    <h3>ä»Šæ—¥ä½ç½®è¨­å®š</h3>

    <label>æ¨¡ç³Šæç¤ºï¼ˆhintï¼‰</label>
    <textarea id="hint" rows="2"></textarea>

    <label>é¡¯ç¤ºåŠå¾‘ï¼ˆå…¬å°ºï¼‰</label>
    <input id="radius" value="300">

    <label>ç·¯åº¦ï¼ˆlatï¼‰</label>
    <input id="lat">

    <label>ç¶“åº¦ï¼ˆlngï¼‰</label>
    <input id="lng">

    <button onclick="saveConfig()">ğŸ’¾ ä¿å­˜è¨­ç½®</button>

    <hr>

    <h3>æœå°‹åœ°é»ï¼ˆåœ°å / è·¯åï¼‰</h3>
    <input id="searchBox" placeholder="ä¾‹å¦‚ï¼šé«˜é›„è»Šç«™ã€å°åŒ—101">
    <button onclick="searchLocation()">ğŸ” æœå°‹</button>

    <div id="map"></div>

    <hr>

    <h3>ğŸ§Ÿ é»‘åå–®ç®¡ç†ï¼ˆblocked_uuidsï¼‰</h3>
    <div id="blockedList">è®€å–ä¸­â€¦</div>

    <hr>

    <h3>ğŸ“œ å­˜å–ç´€éŒ„ï¼ˆaccess_logsï¼‰</h3>
    <div id="logList">è®€å–ä¸­â€¦</div>

</div>
<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://bbbvgqlvhzgccylqszoh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJiYnZncWx2aHpnY2N5bHFzem9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTE2NzQsImV4cCI6MjA4MDg2NzY3NH0.iuzwUbrWfHm0quV05qBJTFIO4_-uJMSd4DT_1U9awgk"
);

/* ----------------------------------------------------
   ğŸ” ç™»å…¥é‚è¼¯ï¼ˆç”¨ä½ çš„ MD5 æ¯”å°ï¼‰
---------------------------------------------------- */

const ACC_MD5 = "0192023a7bbd73250516f069df18b500";  
const PWD_MD5 = "8a6f2805b4515ac12058e79e66539be9";   

window.login = function () {
    const acc = document.getElementById("acc").value.trim();
    const pwd = document.getElementById("pwd").value.trim();

    if (md5(acc) === ACC_MD5 && md5(pwd) === PWD_MD5) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminBox").style.display = "block";

        document.getElementById("helpBtn").style.display = "flex";
        document.getElementById("guidePopup").style.display = "block";

        initMap();
        loadConfig();
        loadBlocked();
        loadLogs();
    } else {
        alert("å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
    }
};

/* èªªæ˜æŒ‰éˆ• */
document.getElementById("helpBtn").onclick = () => {
    document.getElementById("guidePopup").style.display = "block";
};
document.getElementById("guideClose").onclick = () => {
    document.getElementById("guidePopup").style.display = "none";
};


/* ----------------------------------------------------
   ğŸ—ºï¸ åœ°åœ–åˆå§‹åŒ–
---------------------------------------------------- */

let map, marker;

function initMap() {
    map = L.map("map").setView([25.033964, 121.564468], 17);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
    }).addTo(map);

    marker = L.marker([25.033964, 121.564468], { draggable: true })
        .addTo(map);

    /* æ‹–æ›³æ›´æ–°åº§æ¨™ */
    marker.on("dragend", () => {
        const pos = marker.getLatLng();
        updateLatLng(pos.lat, pos.lng);
        autoHint(pos.lat, pos.lng);
    });

    /* é»æ“Šåœ°åœ–æ›´æ–°åº§æ¨™ */
    map.on("click", function (e) {
        marker.setLatLng(e.latlng);
        updateLatLng(e.latlng.lat, e.latlng.lng);
        autoHint(e.latlng.lat, e.latlng.lng);
    });
}

function updateLatLng(lat, lng) {
    document.getElementById("lat").value = lat;
    document.getElementById("lng").value = lng;
}


/* ----------------------------------------------------
   ğŸ” æœå°‹åœ°åï¼ˆNominatimï¼‰
---------------------------------------------------- */
window.searchLocation = async function () {
    const keyword = document.getElementById("searchBox").value.trim();
    if (!keyword) return alert("è«‹è¼¸å…¥åœ°å");

    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}`;
    const data = await fetch(url).then(r => r.json());

    if (data.length === 0) return alert("æŸ¥ç„¡åœ°å");

    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);

    map.setView([lat, lon], 17);
    marker.setLatLng([lat, lon]);
    updateLatLng(lat, lon);
    autoHint(lat, lon);
};


/* ----------------------------------------------------
   ğŸ¯ è‡ªå‹• hintï¼ˆreverse geocodeï¼‰
---------------------------------------------------- */

async function autoHint(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
    const info = await fetch(url).then(r => r.json());

    const display = info.display_name || "é™„è¿‘";
    const r = document.getElementById("radius").value || 300;

    document.getElementById("hint").value =
        `ä»Šå¤©æˆ‘å€‘åœ¨ã€Œ${display}ã€é™„è¿‘ ${r} å…¬å°ºå…§ï¼`;
}


/* ----------------------------------------------------
   ğŸ’¾ ä¿å­˜è¨­å®šåˆ° Supabase
---------------------------------------------------- */

window.saveConfig = async function () {
    const lat = parseFloat(document.getElementById("lat").value);
    const lng = parseFloat(document.getElementById("lng").value);
    const radius = parseInt(document.getElementById("radius").value);
    const hint = document.getElementById("hint").value;

    const { error } = await supabase
        .from("location_config")
        .update({
            lat, lng, radius, hint,
            updated_at: new Date().toISOString()
        })
        .eq("id", 1);

    if (error) alert("ä¿å­˜å¤±æ•—ï¼š" + error.message);
    else alert("æ›´æ–°æˆåŠŸï¼");
};
/* ----------------------------------------------------
   ğŸ§Ÿ é»‘åå–®ç®¡ç† blocked_uuids
---------------------------------------------------- */

async function loadBlocked() {
    const box = document.getElementById("blockedList");
    box.innerHTML = "è®€å–ä¸­â€¦";

    const { data, error } = await supabase
        .from("blocked_uuids")
        .select("*")
        .order("id", { ascending: false });

    if (error) {
        box.innerHTML = "è®€å–å¤±æ•—ï¼š" + error.message;
        return;
    }

    if (!data || data.length === 0) {
        box.innerHTML = "ç›®å‰æ²’æœ‰å°é–ä»»ä½• UUID";
        return;
    }

    let html = `<table>
        <tr>
            <th>UUID</th>
            <th>å°é–æ™‚é–“</th>
            <th>æ“ä½œ</th>
        </tr>`;

    data.forEach(row => {
        html += `
        <tr>
            <td>${row.uuid}</td>
            <td>${new Date(row.created_at).toLocaleString()}</td>
            <td><button onclick="unblockUUID('${row.uuid}')">è§£é™¤å°é–</button></td>
        </tr>`;
    });

    html += "</table>";
    box.innerHTML = html;
}

window.unblockUUID = async function (uuid) {
    const ok = confirm(`ç¢ºå®šè¦è§£é™¤å°é–ï¼Ÿ\n${uuid}`);
    if (!ok) return;

    await supabase.from("blocked_uuids").delete().eq("uuid", uuid);
    alert("å·²è§£é™¤å°é–");
    loadBlocked();
};


/* ----------------------------------------------------
   â• æ–°å¢å°é– UUID
---------------------------------------------------- */

window.blockUUID = async function (uuid) {
    const ok = confirm(`ç¢ºå®šè¦å°é–é€™å€‹ UUIDï¼Ÿ\n${uuid}`);
    if (!ok) return;

    await supabase.from("blocked_uuids").insert({
        uuid,
        created_at: new Date().toISOString()
    });

    alert("å·²åŠ å…¥é»‘åå–®ï¼");
    loadBlocked();
};


/* ----------------------------------------------------
   ğŸ“œ å­˜å–ç´€éŒ„ access_logs
---------------------------------------------------- */

async function loadLogs() {
    const box = document.getElementById("logList");
    box.innerHTML = "è®€å–ä¸­â€¦";

    const { data, error } = await supabase
        .from("access_logs")
        .select("*")
        .order("id", { ascending: false })
        .limit(200);  // é¿å…å¤ªå¤š

    if (error) {
        box.innerHTML = "è®€å–å¤±æ•—ï¼š" + error.message;
        return;
    }

    if (!data || data.length === 0) {
        box.innerHTML = "ç›®å‰æ²’æœ‰å­˜å–ç´€éŒ„";
        return;
    }

    let html = `<table>
        <tr>
            <th>UUID</th>
            <th>è·é›¢</th>
            <th>é€²åœˆ</th>
            <th>åº§æ¨™</th>
            <th>æ™‚é–“</th>
            <th>æ“ä½œ</th>
        </tr>`;

    data.forEach(row => {
        html += `
        <tr>
            <td>${row.uuid}</td>
            <td>${row.distance} m</td>
            <td>${row.entered ? "âœ”" : "â€”"}</td>
            <td>${row.lat}, ${row.lng}</td>
            <td>${new Date(row.timestamp).toLocaleString()}</td>
            <td>
                <button onclick="blockUUID('${row.uuid}')">å°é–</button>
            </td>
        </tr>`;
    });

    html += "</table>";

    box.innerHTML = html;
}

/* ----------------------------------------------------
   ğŸ“Œ å¾ Supabase è®€å–ç›®å‰è¨­å®šï¼ˆä½ç½® / åŠå¾‘ / hintï¼‰
---------------------------------------------------- */
async function loadConfig() {
    const { data, error } = await supabase
        .from("location_config")
        .select("*")
        .eq("id", 1)
        .single();

    if (error || !data) {
        alert("è®€å–è¨­å®šå¤±æ•—");
        return;
    }

    document.getElementById("lat").value = data.lat;
    document.getElementById("lng").value = data.lng;
    document.getElementById("radius").value = data.radius;
    document.getElementById("hint").value = data.hint;

    // æ›´æ–°åœ°åœ–ä½ç½®
    if (map && marker) {
        marker.setLatLng([data.lat, data.lng]);
        map.setView([data.lat, data.lng], 17);
    }
}


</script>

</body>
</html>
