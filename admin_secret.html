<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>擺攤位置管理後台</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- MD5 -->
<script src="https://cdn.jsdelivr.net/npm/blueimp-md5/js/md5.min.js"></script>

<style>
    body { font-family: Arial; padding: 20px; }
    #loginBox, #adminBox { max-width: 650px; margin: auto; }
    #adminBox { display:none; }
    #map { height: 380px; margin-top: 10px; }
    input, button { padding: 8px; width: 100%; margin: 5px 0; }
</style>

</head>
<body>

<h2 style="text-align:center;">擺攤位置管理後台</h2>

<!-- Login -->
<div id="loginBox">
    <h3>登入</h3>
    <input id="acc" placeholder="帳號：admin123"/>
    <input id="pwd" placeholder="密碼：aa123456" type="password"/>
    <button onclick="login()">登入</button>
</div>

<!-- Main Admin -->
<div id="adminBox">
    <h3>今日位置設定</h3>

    <label>模糊提示（hint）</label>
    <input id="hint"/>

    <label>半徑（公尺）</label>
    <input id="radius" value="300"/>

    <label>緯度（lat）</label>
    <input id="lat"/>

    <label>經度（lng）</label>
    <input id="lng"/>

    <button onclick="saveConfig()">保存（更新 Supabase）</button>

    <h3>選擇地點（搜尋 / 點地圖）</h3>
    <input id="searchBox" placeholder="搜尋地名，如：台北車站"/>
    <button onclick="searchLocation()">搜尋</button>

    <div id="map"></div>
</div>


<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://bbbvgqlvhzgccylqszoh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJiYnZncWx2aHpnY2N5bHFzem9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTE2NzQsImV4cCI6MjA4MDg2NzY3NH0.iuzwUbrWfHm0quV05qBJTFIO4_-uJMSd4DT_1U9awgk"
);

/* ------------------ 登入 -------------------- */
window.login = function () {
    const user = document.getElementById("acc").value;
    const pwd = document.getElementById("pwd").value;

    if (user === "admin123" && md5(pwd) === md5("aa123456")) {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("adminBox").style.display = "block";
        initMap();
    } else {
        alert("帳號或密碼錯誤！");
    }
};

/* ------------------ Leaflet Map -------------------- */

let map, marker;

function initMap() {
    map = L.map("map").setView([25.033964, 121.564468], 16);

    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
    }).addTo(map);

    marker = L.marker([25.033964, 121.564468], { draggable: true }).addTo(map);

    marker.on("dragend", () => {
        const pos = marker.getLatLng();
        updateLatLng(pos.lat, pos.lng);
        autoHint(pos.lat, pos.lng);
    });

    map.on("click", function (e) {
        marker.setLatLng(e.latlng);
        updateLatLng(e.latlng.lat, e.latlng.lng);
        autoHint(e.latlng.lat, e.latlng.lng);
    });
}

function updateLatLng(lat, lng) {
    document.getElementById("lat").value = lat;
    document.getElementById("lng").value = lng;
}

/* ------------------ 搜尋地點 -------------------- */
window.searchLocation = async function () {
    const keyword = document.getElementById("searchBox").value;
    if (!keyword) return alert("請輸入地名");

    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(keyword)}`;
    const data = await fetch(url).then(r => r.json());

    if (data.length === 0) return alert("查無地名");

    const lat = parseFloat(data[0].lat);
    const lon = parseFloat(data[0].lon);

    map.setView([lat, lon], 17);
    marker.setLatLng([lat, lon]);
    updateLatLng(lat, lon);
    autoHint(lat, lon);
};

/* ------------------ Reverse Geocode：找最近地標 -------------------- */
async function autoHint(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`;
    const r = await fetch(url).then(r => r.json());

    const display = r.display_name || "附近";

    const radius = document.getElementById("radius").value;
    document.getElementById("hint").value =
        `今天我們在「${display}」附近 ${radius} 公尺內！`;
}

/* ------------------ 保存到 Supabase -------------------- */
window.saveConfig = async function () {
    const lat = parseFloat(document.getElementById("lat").value);
    const lng = parseFloat(document.getElementById("lng").value);
    const radius = parseInt(document.getElementById("radius").value);
    const hint = document.getElementById("hint").value;

    const { data, error } = await supabase
        .from("location_config")
        .update({
            lat,
            lng,
            radius,
            hint,
            updated_at: new Date().toISOString()
        })
        .eq("id", 1);

    if (error) alert("保存失敗：" + error.message);
    else alert("更新成功！");
};

</script>

</body>
</html>
