<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ä»Šæ—¥æ“ºæ”¤ä½ç½®</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
        overflow: hidden;
    }

    /* å…¨è¢å¹•åœ°åœ– */
    #map {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
    }

    /* ä¸Šæ–¹æç¤ºå¡ */
    #infoCard {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 500px;
        background: rgba(0,0,0,0.65);
        color: white;
        padding: 15px 18px;
        border-radius: 10px;
        font-size: 16px;
        line-height: 1.4em;
        z-index: 10;
        backdrop-filter: blur(5px);
        text-align: center;
    }

    /* åº•éƒ¨å°èˆªæŒ‰éˆ• */
    #navBtn {
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 60px);
        max-width: 500px;
        padding: 15px;
        font-size: 20px;
        border-radius: 12px;
        border: none;
        background: #1e90ff;
        color: white;
        font-weight: bold;
        display: none;
        z-index: 10;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.25);
    }
</style>
</head>
<body>

<!-- ä¸Šæ–¹æç¤ºå¡ -->
<div id="infoCard">æ­£åœ¨å–å¾—ä½ çš„æ‰€åœ¨ä½ç½®â€¦</div>

<!-- åœ°åœ– -->
<div id="map"></div>

<!-- å°èˆªæŒ‰éˆ•ï¼ˆé€²åœˆå¾Œé¡¯ç¤ºï¼‰ -->
<button id="navBtn">é–‹å§‹å°èˆª</button>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://bbbvgqlvhzgccylqszoh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJiYnZncWx2aHpnY2N5bHFzem9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTE2NzQsImV4cCI6MjA4MDg2NzY3NH0.iuzwUbrWfHm0quV05qBJTFIO4_-uJMSd4DT_1U9awgk"
);

/* UUID */
let uuid = localStorage.getItem("uuid");
if (!uuid) {
    uuid = crypto.randomUUID();
    localStorage.setItem("uuid", uuid);
}

/* è®€å–åŸºæœ¬è¨­å®šï¼ˆä¸å« hintï¼‰ */
const { data: cfg, error } = await supabase
    .from("location_config")
    .select("lat, lng, radius")
    .eq("id", 1)
    .single();

if (error) {
    document.getElementById("infoCard").innerText = "è®€å–è¨­å®šå¤±æ•—ã€‚";
    throw error;
}

const storeLat = cfg.lat;
const storeLng = cfg.lng;
const radius   = cfg.radius;

/* é»‘åå–®æª¢æŸ¥ */
const { data: blocked } = await supabase
    .from("blocked_uuids")
    .select("*")
    .eq("uuid", uuid);

if (blocked && blocked.length > 0) {
    document.getElementById("infoCard").innerHTML =
        "âš  ä½ å·²è¢«é™åˆ¶æŸ¥çœ‹ä½ç½®ã€‚";
    throw new Error("blocked");
}

/* Leaflet map */
const map = L.map("map", {
    zoomControl: false
}).setView([storeLat, storeLng], 17);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const storeMarker = L.marker([storeLat, storeLng]).addTo(map);
storeMarker.bindPopup(`<b>åº—å®¶ä½ç½®</b><br><a href="https://www.google.com/maps/dir/?api=1&destination=${storeLat},${storeLng}" target="_blank">åœ¨ Google Maps æ‰“é–‹</a>`);

L.circle([storeLat, storeLng], {
    radius: radius,
    color: "blue",
    fillColor: "lightblue",
    fillOpacity: 0.2
}).addTo(map);

let userMarker = null;
let hintLoaded = false;
let hintText = "";

/* GPS è¿½è¹¤ */
navigator.geolocation.watchPosition(async pos => {

    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;

    /* é¡¯ç¤ºç”¨æˆ¶ marker */
    if (!userMarker) {
        userMarker = L.marker([userLat, userLng], {
            icon: L.divIcon({
                html: '<div style="width:14px;height:14px;background:#1e90ff;border-radius:50%;border:2px solid white;"></div>',
                className: ""
            })
        }).addTo(map);
    } else {
        userMarker.setLatLng([userLat, userLng]);
    }

    const dist = getDistance(userLat, userLng, storeLat, storeLng);

    if (dist <= radius) {

        /* ç¬¬ä¸€æ¬¡é€²åœˆ â†’ å– hint */
        if (!hintLoaded) {
            const r = await supabase
                .from("location_config")
                .select("hint")
                .eq("id", 1)
                .single();

            hintText = r.data?.hint || "";
            hintLoaded = true;
        }

        document.getElementById("infoCard").innerHTML =
            `ğŸ‰ å·²æŠµé”ç‡Ÿæ¥­å€åŸŸï¼ˆè·é›¢ ${Math.floor(dist)} å…¬å°ºï¼‰<br>${hintText}`;

        const btn = document.getElementById("navBtn");
        btn.style.display = "block";
        btn.onclick = () => {
            window.location.href =
                `https://www.google.com/maps/dir/?api=1&destination=${storeLat},${storeLng}`;
        };

    } else {
        document.getElementById("infoCard").innerHTML =
            `ä½ è·é›¢åº—å®¶ç´„ <b>${Math.floor(dist)}</b> å…¬å°ºï¼Œå†é è¿‘å³å¯æŸ¥çœ‹è©³ç´°ä½ç½®ã€‚`;
    }

    /* å¯«å…¥ log */
    await supabase.from("access_logs").insert({
        uuid,
        timestamp: new Date().toISOString(),
        distance: Math.floor(dist),
        entered: dist <= radius,
        lat: Math.round(userLat * 1000) / 1000,
        lng: Math.round(userLng * 1000) / 1000
    });

});

/* è·é›¢å…¬å¼ */
function getDistance(lat1, lon1, lat2, lon2) {
    function toRad(v){ return v * Math.PI / 180; }
    const R = 6371000;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
</script>

</body>
</html>
