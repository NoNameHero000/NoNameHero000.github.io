<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ä»Šæ—¥æ“ºæ”¤ä½ç½®</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
    body { font-family: Arial; padding: 10px; }
    #map { height: 380px; margin-top: 10px; }
    #msg { font-size: 18px; margin-top: 10px; }
    #navBtn { 
        padding: 12px; 
        background: #0078ff; 
        color: white; 
        border: none; 
        width: 100%; 
        margin-top: 10px; 
        font-size: 18px;
        display: none;
        border-radius: 6px;
    }
</style>

</head>
<body>

<h2>ä»Šæ—¥ç‡Ÿæ¥­è³‡è¨Š</h2>
<div id="msg">è¼‰å…¥ä¸­...</div>
<div id="map"></div>
<button id="navBtn">é–‹å§‹å°èˆª</button>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://bbbvgqlvhzgccylqszoh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJiYnZncWx2aHpnY2N5bHFzem9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTE2NzQsImV4cCI6MjA4MDg2NzY3NH0.iuzwUbrWfHm0quV05qBJTFIO4_-uJMSd4DT_1U9awgk"
);

/* ---------------------------------------------------
   å®¢æˆ¶ç«¯ UUIDï¼ˆè£ç½®å”¯ä¸€è­˜åˆ¥ç¢¼ï¼‰
--------------------------------------------------- */
let uuid = localStorage.getItem("uuid");
if (!uuid) {
    uuid = crypto.randomUUID();
    localStorage.setItem("uuid", uuid);
}

/* ---------------------------------------------------
   è®€å–ä»Šæ—¥è¨­å®šï¼ˆlocation_configï¼‰
--------------------------------------------------- */
const { data: cfg, error } = await supabase
    .from("location_config")
    .select("*")
    .eq("id", 1)
    .single();

if (error) {
    document.getElementById("msg").innerText = "ç„¡æ³•è®€å–ä½ç½®è¨­å®šã€‚";
    throw error;
}

const storeLat = cfg.lat;
const storeLng = cfg.lng;
const radius = cfg.radius;
const hint = cfg.hint;

document.getElementById("msg").innerText = hint;

/* ---------------------------------------------------
   æª¢æŸ¥æ˜¯å¦åœ¨é»‘åå–®
--------------------------------------------------- */
const { data: blocked } = await supabase
    .from("blocked_uuids")
    .select("*")
    .eq("uuid", uuid);

if (blocked && blocked.length > 0) {
    document.getElementById("msg").innerHTML =
        "âš  ä½ å·²è¢«é™åˆ¶æŸ¥çœ‹åº—å®¶ä½ç½®ã€‚";
    throw new Error("Blocked user");
}

/* ---------------------------------------------------
   Leaflet åœ°åœ–åˆå§‹åŒ–
--------------------------------------------------- */
const map = L.map("map").setView([storeLat, storeLng], 16);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

L.marker([storeLat, storeLng]).addTo(map);

L.circle([storeLat, storeLng], {
    radius: radius,
    color: "blue",
    fillColor: "lightblue",
    fillOpacity: 0.2
}).addTo(map);

let userMarker = null;

/* ---------------------------------------------------
   å³æ™‚å®šä½ï¼ˆwatchPositionï¼‰
--------------------------------------------------- */
navigator.geolocation.watchPosition(async pos => {

    const userLat = pos.coords.latitude;
    const userLng = pos.coords.longitude;

    if (!userMarker) {
        userMarker = L.marker([userLat, userLng], {
            icon: L.divIcon({
                html: '<div style="width:12px;height:12px;background:blue;border-radius:50%;"></div>',
                className: ""
            })
        }).addTo(map);
    } else {
        userMarker.setLatLng([userLat, userLng]);
    }

    const dist = distance(userLat, userLng, storeLat, storeLng);

    /* é¡¯ç¤ºè·é›¢æç¤º */
    if (dist <= radius) {
        document.getElementById("msg").innerHTML =
            `ğŸ‰ ä½ å·²é€²å…¥åº—å®¶é™„è¿‘ï¼ï¼ˆè·é›¢ï¼š${Math.floor(dist)} å…¬å°ºï¼‰`;

        /* é¡¯ç¤ºå°èˆªæŒ‰éˆ• */
        const navBtn = document.getElementById("navBtn");
        navBtn.style.display = "block";
        navBtn.onclick = () => {
            window.location.href =
                `https://www.google.com/maps/dir/?api=1&destination=${storeLat},${storeLng}`;
        };

    } else {
        document.getElementById("msg").innerHTML =
            `ä½ è·é›¢åº—å®¶ç´„ ${Math.floor(dist)} å…¬å°ºï¼Œå†é è¿‘ä¸€äº›å³å¯çœ‹åˆ°å°èˆªæŒ‰éˆ•ã€‚`;
    }

    /* è¨˜éŒ„ access_logsï¼ˆåŒ¿åï¼‰ */
    await supabase.from("access_logs").insert({
        uuid,
        timestamp: new Date().toISOString(),
        distance: Math.floor(dist),
        entered: dist <= radius,
        lat: Math.round(userLat * 1000) / 1000,   // æ¨¡ç³ŠåŒ–ä½ç½®ï¼ˆ100mï¼‰
        lng: Math.round(userLng * 1000) / 1000
    });

});

/* ---------------------------------------------------
   è·é›¢å…¬å¼
--------------------------------------------------- */
function distance(lat1, lon1, lat2, lon2) {
    function toRad(v){ return v * Math.PI / 180; }
    const R = 6371000;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

</script>

</body>
</html>
