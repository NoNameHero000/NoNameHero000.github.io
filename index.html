<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ä»Šæ—¥æ“ºæ”¤ä½ç½®</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, Arial, sans-serif;
        overflow: hidden;
        background: #f5f5f5;
    }

    /* å…¨è¢å¹•åœ°åœ– */
    #map {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        z-index: 1;
    }

    /* æç¤ºå¡ */
    #infoCard {
        position: fixed;
        top: 75px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 40px);
        max-width: 500px;
        background: rgba(0,0,0,0.65);
        color: white;
        padding: 15px 18px;
        border-radius: 12px;
        font-size: 16px;
        line-height: 1.45em;
        z-index: 10;
        backdrop-filter: blur(6px);
        text-align: center;
    }

    /* å¯é—œé–‰çš„é€æ˜æç¤º */
    #tipBubble {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 12px 16px;
        background: rgba(0,0,0,0.55);
        color: #fff;
        border-radius: 10px;
        font-size: 15px;
        backdrop-filter: blur(4px);
        z-index: 12;
    }
    #closeTip {
        margin-left: 10px;
        color: #ffcccc;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
    }

    /* å°èˆªæŒ‰éˆ• */
    #navBtn {
        position: fixed;
        bottom: 25px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 60px);
        max-width: 500px;
        padding: 16px;
        font-size: 20px;
        border-radius: 12px;
        border: none;
        background: #1e90ff;
        color: white;
        font-weight: bold;
        display: none;
        z-index: 10;
        box-shadow: 0px 4px 12px rgba(0,0,0,0.25);
    }

    /* "å›åˆ°æˆ‘çš„ä½ç½®" æŒ‰éˆ• */
    #locateBtn {
        position: fixed;
        bottom: 95px;
        right: 20px;
        width: 52px;
        height: 52px;
        border-radius: 50%;
        background: rgba(255,255,255,0.9);
        box-shadow: 0 2px 10px rgba(0,0,0,0.25);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 12;
        cursor: pointer;
        font-size: 24px;
        user-select: none;
    }

    /* æœ€å¾Œæ›´æ–°æ™‚é–“ï¼ˆå³ä¸Šè§’ï¼‰ */
    #updateTime {
        position: fixed;
        top: 50px;
        right: 10px;
        font-size: 12px;
        color: #ffffffcc;
        background: rgba(0,0,0,0.4);
        padding: 4px 8px;
        border-radius: 6px;
        z-index: 11;
    }

</style>
</head>
<body>

<!-- å¯é—œé–‰æç¤º -->
<div id="tipBubble">
    ğŸ’¡ å°æç¤ºï¼šå¯é»è—è‰²åœ–æ¨™é–‹å•Ÿ Google å°èˆª
    <span id="closeTip">Ã—</span>
</div>

<!-- ä½ç½®è¨­å®šæ™‚é–“ -->
<div id="updateTime">æ›´æ–°æ™‚é–“ï¼š--</div>

<!-- ä¸»æç¤ºå¡ -->
<div id="infoCard">æ­£åœ¨å–å¾—ä½ çš„æ‰€åœ¨ä½ç½®â€¦</div>

<!-- å…¨è¢å¹•åœ°åœ– -->
<div id="map"></div>

<!-- å›åˆ°è‡ªå·±çš„ä½ç½® -->
<div id="locateBtn">â¦¿</div>

<!-- åº•éƒ¨å°èˆªæŒ‰éˆ• -->
<button id="navBtn">é–‹å§‹å°èˆª</button>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js";

const supabase = createClient(
  "https://bbbvgqlvhzgccylqszoh.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJiYnZncWx2aHpnY2N5bHFzem9oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyOTE2NzQsImV4cCI6MjA4MDg2NzY3NH0.iuzwUbrWfHm0quV05qBJTFIO4_-uJMSd4DT_1U9awgk"
);

/* UUID */
let uuid = localStorage.getItem("uuid");
if (!uuid) {
    uuid = crypto.randomUUID();
    localStorage.setItem("uuid", uuid);
}

/* é—œé–‰æç¤ºè¨˜æ†¶ */
if (localStorage.getItem("hideTip") === "1") {
    document.getElementById("tipBubble").style.display = "none";
}
document.getElementById("closeTip").onclick = () => {
    document.getElementById("tipBubble").style.display = "none";
    localStorage.setItem("hideTip", "1");
};

/* å…ˆè®€å– lat/lng/radius + created_at */
const { data: cfg, error } = await supabase
    .from("location_config")
    .select("lat, lng, radius, created_at")
    .eq("id", 1)
    .single();

if (!cfg) {
    document.getElementById("infoCard").textContent = "è®€å–è¨­å®šå¤±æ•—";
    throw error;
}

const storeLat = cfg.lat;
const storeLng = cfg.lng;
const radius   = cfg.radius;

/* é¡¯ç¤ºè¨­å®šæ™‚é–“ */
let dt = new Date(cfg.created_at);
document.getElementById("updateTime").textContent =
    `æ›´æ–°æ™‚é–“ï¼š${String(dt.getMonth()+1).padStart(2,'0')}/${String(dt.getDate()).padStart(2,'0')} ${String(dt.getHours()).padStart(2,'0')}:${String(dt.getMinutes()).padStart(2,'0')}`;

/* æª¢æŸ¥é»‘åå–® */
const { data: blocked } = await supabase
  .from("blocked_uuids")
  .select("*")
  .eq("uuid", uuid);

if (blocked && blocked.length > 0) {
    document.getElementById("infoCard").innerHTML =
        "âš  ä½ å·²è¢«é™åˆ¶æŸ¥çœ‹ä½ç½®ã€‚";
    throw new Error("blocked");
}

/* Leaflet map */
const map = L.map("map", { zoomControl: false }).setView([storeLat, storeLng], 17);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const storeMarker = L.marker([storeLat, storeLng]).addTo(map);
storeMarker.bindPopup(`<b>åº—å®¶ä½ç½®</b><br><a href="https://www.google.com/maps/dir/?api=1&destination=${storeLat},${storeLng}" target="_blank">åœ¨ Google Maps é–‹å•Ÿ</a>`);

L.circle([storeLat, storeLng], {
    radius,
    color: "blue",
    fillColor: "lightblue",
    fillOpacity: 0.25
}).addTo(map);

let userMarker = null;
let userLat = null;
let userLng = null;
let hintLoaded = false;
let hintText = "";

/* å›åˆ°æˆ‘çš„ä½ç½® */
document.getElementById("locateBtn").onclick = () => {
    if (userLat && userLng) {
        map.flyTo([userLat, userLng], 17);
    }
};

/* åœ°ç†å®šä½ */
navigator.geolocation.watchPosition(async pos => {

    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;

    /* é¡¯ç¤º marker */
    if (!userMarker) {
        userMarker = L.marker([userLat, userLng], {
            icon: L.divIcon({
                html: '<div style="width:15px;height:15px;background:#1e90ff;border-radius:50%;border:2px solid white;"></div>',
                className: ""
            })
        }).addTo(map);
    } else {
        userMarker.setLatLng([userLat, userLng]);
    }

    /* è·é›¢è¨ˆç®— */
    const dist = getDistance(userLat, userLng, storeLat, storeLng);

    /* æ›´æ–°æ™‚é–“ï¼ˆå³ä¸Šè§’ï¼‰ */
    let now = new Date();
    document.getElementById("updateTime").textContent =
        `æœ€å¾Œæ›´æ–°ï¼š${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;

    if (dist <= radius) {

        /* é¦–æ¬¡é€²åœˆå¾Œæ‰è«‹æ±‚ hint */
        if (!hintLoaded) {
            const r = await supabase
                .from("location_config")
                .select("hint")
                .eq("id", 1)
                .single();
            hintText = r.data?.hint || "";
            hintLoaded = true;
        }

        document.getElementById("infoCard").innerHTML =
            `ğŸ‰ å·²æŠµé”ç‡Ÿæ¥­å€åŸŸï¼ˆè·é›¢ ${Math.floor(dist)} å…¬å°ºï¼‰<br>${hintText}`;

        const btn = document.getElementById("navBtn");
        btn.style.display = "block";
        btn.onclick = () => {
            window.location.href =
                `https://www.google.com/maps/dir/?api=1&destination=${storeLat},${storeLng}`;
        };

    } else {

        document.getElementById("infoCard").innerHTML =
            `ä½ è·é›¢åº—å®¶ç´„ <b>${Math.floor(dist)}</b> å…¬å°ºï¼Œå†é è¿‘å³å¯æŸ¥çœ‹è©³ç´°ä½ç½®ã€‚`;

        document.getElementById("navBtn").style.display = "none";
    }

    /* è¨˜éŒ„ log */
    await supabase.from("access_logs").insert({
        uuid,
        timestamp: new Date().toISOString(),
        distance: Math.floor(dist),
        entered: dist <= radius,
        lat: Math.round(userLat * 1000) / 1000,
        lng: Math.round(userLng * 1000) / 1000
    });

});

/* è·é›¢å…¬å¼ */
function getDistance(lat1, lon1, lat2, lon2) {
    function toRad(v){ return v * Math.PI / 180; }
    const R = 6371000;
    const dLat = toRad(lat2-lat1);
    const dLon = toRad(lon2-lon1);
    const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1)) *
        Math.cos(toRad(lat2)) *
        Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

</script>

</body>
</html>
